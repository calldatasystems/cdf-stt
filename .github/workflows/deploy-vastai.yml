name: Deploy CDF STT (Vast.ai)

on:
  push:
    branches:
      - main
    paths:
      - 'api/**'
      - 'app/**'
      - 'Dockerfile'
      - 'requirements.txt'
      - '.github/workflows/deploy-vastai.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  deploy-vastai:
    name: Deploy to Vast.ai
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vast.ai CLI
        run: |
          wget https://raw.githubusercontent.com/vast-ai/vast-python/master/vast.py
          chmod +x vast.py
          sudo mv vast.py /usr/local/bin/vast

      - name: Configure Vast.ai API
        run: |
          vast set api-key ${{ secrets.VASTAI_API_KEY }}

      - name: Search for RTX 4090 instances
        id: search
        run: |
          echo "Searching for available RTX 4090 instances..."
          vast search offers 'reliability > 0.95 num_gpus=1 disk_space >= 50 gpu_name=RTX_4090' --raw > offers.json

          # Check if we got any results
          if [ ! -s offers.json ] || [ "$(cat offers.json)" = "[]" ]; then
            echo "No RTX 4090 instances available, searching for any RTX 40-series..."
            vast search offers 'reliability > 0.95 num_gpus=1 disk_space >= 50 gpu_ram >= 16' --raw > offers.json
          fi

          # Get the cheapest offer
          OFFER_ID=$(jq -r 'sort_by(.dph_total) | .[0].id' offers.json)
          echo "Selected offer ID: $OFFER_ID"
          echo "offer_id=$OFFER_ID" >> $GITHUB_OUTPUT

      - name: Create or Update Instance
        id: deploy
        run: |
          # Check if instance already exists
          EXISTING_INSTANCE=$(vast show instances --raw | jq -r '.[] | select(.label=="cdf-stt-prod") | .id' 2>/dev/null || echo "")

          if [ -n "$EXISTING_INSTANCE" ]; then
            echo "Updating existing instance: $EXISTING_INSTANCE"
            vast destroy instance $EXISTING_INSTANCE
            sleep 5
          fi

          echo "Creating new instance with offer ID: ${{ steps.search.outputs.offer_id }}"

          # Create instance - Vast.ai will automatically forward ports
          # Let Docker CMD run naturally - don't override with --onstart-cmd
          CREATE_OUTPUT=$(vast create instance ${{ steps.search.outputs.offer_id }} \
            --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            --disk 50 \
            --label cdf-stt-prod \
            --ssh \
            --env '-e WHISPER_MODEL_SIZE=large-v3 -e WHISPER_DEVICE=cuda -e WHISPER_COMPUTE_TYPE=float16' \
            --raw 2>&1)

          echo "Create output: $CREATE_OUTPUT"

          # Extract instance ID - try multiple fields
          INSTANCE_ID=$(echo "$CREATE_OUTPUT" | jq -r '.new_contract // .instance_id // .id' 2>/dev/null || echo "")

          if [ -z "$INSTANCE_ID" ] || [ "$INSTANCE_ID" = "null" ]; then
            echo "ERROR: Failed to get instance ID from create response"
            echo "Full response: $CREATE_OUTPUT"
            exit 1
          fi

          echo "Instance created with ID: $INSTANCE_ID"
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT

      - name: Wait for Instance to be Ready
        run: |
          INSTANCE_ID="${{ steps.deploy.outputs.instance_id }}"
          echo "Waiting for instance $INSTANCE_ID to be ready..."

          for i in {1..60}; do
            STATUS=$(vast show instances --raw 2>/dev/null | jq -r --arg id "$INSTANCE_ID" '.[] | select(.id==($id|tonumber)) | .actual_status' || echo "unknown")

            echo "Attempt $i/60: Instance status is '$STATUS'"

            if [ "$STATUS" = "running" ]; then
              echo "Instance is running!"
              break
            fi

            if [ $i -eq 60 ]; then
              echo "Timeout waiting for instance to start"
              exit 1
            fi

            sleep 10
          done

      - name: Get Instance Connection Info
        id: connection
        run: |
          INSTANCE_ID="${{ steps.deploy.outputs.instance_id }}"
          INSTANCE_INFO=$(vast show instances --raw 2>/dev/null | jq -r --arg id "$INSTANCE_ID" '.[] | select(.id==($id|tonumber))')

          echo "Instance info: $INSTANCE_INFO"

          # Extract connection details
          PUBLIC_IP=$(echo "$INSTANCE_INFO" | jq -r '.public_ipaddr // "unknown"')
          SSH_HOST=$(echo "$INSTANCE_INFO" | jq -r '.ssh_host // "unknown"')
          SSH_PORT=$(echo "$INSTANCE_INFO" | jq -r '.ssh_port // "unknown"')

          # Extract port mappings - find the external port that maps to internal 8000
          # Format in Vast.ai: "ports": {"8000/tcp": [{"HostIp": "0.0.0.0", "HostPort": "12345"}]}
          EXTERNAL_PORT=$(echo "$INSTANCE_INFO" | jq -r '.ports["8000/tcp"][0].HostPort // "unknown"')

          # Alternative: check direct_port_start if direct port was assigned
          if [ "$EXTERNAL_PORT" = "unknown" ] || [ -z "$EXTERNAL_PORT" ]; then
            EXTERNAL_PORT=$(echo "$INSTANCE_INFO" | jq -r '.direct_port_start // "unknown"')
          fi

          echo "Public IP: $PUBLIC_IP"
          echo "SSH Host: $SSH_HOST"
          echo "SSH Port: $SSH_PORT"
          echo "External Port (for 8000): $EXTERNAL_PORT"

          echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "ssh_host=$SSH_HOST" >> $GITHUB_OUTPUT
          echo "ssh_port=$SSH_PORT" >> $GITHUB_OUTPUT
          echo "external_port=$EXTERNAL_PORT" >> $GITHUB_OUTPUT

      - name: Health Check
        run: |
          PUBLIC_IP="${{ steps.connection.outputs.public_ip }}"
          EXTERNAL_PORT="${{ steps.connection.outputs.external_port }}"

          if [ "$PUBLIC_IP" = "unknown" ] || [ "$EXTERNAL_PORT" = "unknown" ]; then
            echo "Warning: Could not determine connection details"
            echo "Check Vast.ai console for port mapping: https://vast.ai/console/instances/"
            exit 0
          fi

          API_URL="http://${PUBLIC_IP}:${EXTERNAL_PORT}"
          echo "Testing API at: $API_URL"
          echo "Waiting for API to be healthy..."

          for i in {1..30}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${API_URL}/health" 2>/dev/null || echo "000")

            if [ "$HTTP_CODE" == "200" ]; then
              echo "✓ API is healthy!"
              curl -s "${API_URL}/health" | jq . || curl -s "${API_URL}/health"
              break
            fi

            echo "Attempt $i/30: Health check returned HTTP $HTTP_CODE, waiting..."
            sleep 10
          done

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-vastai]
    if: always()

    steps:
      - name: Deployment Status
        run: |
          echo "=================================================="
          echo "CDF STT Deployment Summary"
          echo "=================================================="
          echo ""
          echo "Build: ${{ needs.build-and-push.result }}"
          echo "Deploy: ${{ needs.deploy-vastai.result }}"
          echo ""
          echo "Image: ${{ needs.build-and-push.outputs.image_tag }}"
          echo ""
          if [ "${{ needs.build-and-push.result }}" = "success" ] && [ "${{ needs.deploy-vastai.result }}" = "success" ]; then
            echo "✓ Deployment completed successfully!"
            echo ""
            echo "Connection Information:"
            echo "  Check the 'Get Instance Connection Info' step above for:"
            echo "  - Public IP"
            echo "  - External Port (forwarded from internal port 8000)"
            echo "  - SSH access details"
            echo ""
            echo "Quick Access:"
            echo "  1. View in Vast.ai console: https://vast.ai/console/instances/"
            echo "  2. Find instance labeled: cdf-stt-prod"
            echo "  3. Note the port mapping for 8000"
            echo ""
            echo "API Endpoints (use PUBLIC_IP:EXTERNAL_PORT):"
            echo "  - Health: http://IP:PORT/health"
            echo "  - Docs: http://IP:PORT/docs"
            echo "  - Transcribe: POST http://IP:PORT/transcribe"
          else
            echo "✗ Deployment failed - check logs above"
            echo ""
            if [ "${{ needs.build-and-push.result }}" != "success" ]; then
              echo "Build failed - check Docker build logs"
            fi
            if [ "${{ needs.deploy-vastai.result }}" != "success" ]; then
              echo "Deployment failed - check Vast.ai deployment logs"
              echo "Common issues:"
              echo "  - Insufficient Vast.ai credits"
              echo "  - No available GPU instances matching criteria"
              echo "  - Port forwarding configuration"
            fi
          fi
          echo ""
          echo "=================================================="
